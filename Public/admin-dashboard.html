<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #059669;
            --danger-color: #dc2626;
            --warning-color: #d97706;
            --info-color: #0891b2;
            --background-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .dashboard-container {
            padding: 2rem;
        }
        .stats-card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .stats-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        .stats-label {
            color: var(--text-secondary);
            font-size: 0.9rem; 
            margin-top: 0.5rem;
        }
        .transaction-table {
            background: var(--card-bg);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .transaction-table th {
            background: var(--background-color);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 1rem;
        }
        .transaction-table td {
            padding: 1rem;
            vertical-align: middle;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: #e9ecef;
            color: #495057;
        }
        .status-confirmed {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-failed {
            background-color: #f8d7da;
            color: #842029;
        }
        .status-success {
            background-color: #198754;
            color: white;
        }
        .status-expired {
            background-color: #e2e3e5;
            color: #41464b;
        }
        .status-payment {
            background-color: #cfe2ff;
            color: #084298;
        }
        .status-release {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-other {
            background-color: #e9ecef;
            color: #495057;
        }
        .dashboard-card {
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .wrong-payment-row {
            background-color: rgba(248, 215, 218, 0.3);
        }
        .wrong-payment-row:hover {
            background-color: rgba(248, 215, 218, 0.5);
        }
        .expired-address-row {
            background-color: rgba(226, 227, 229, 0.3);
        }
        .expired-address-row:hover {
            background-color: rgba(226, 227, 229, 0.5);
        }
        .failed-release-row {
            background-color: rgba(255, 243, 205, 0.3);
        }
        .failed-release-row:hover {
            background-color: rgba(255, 243, 205, 0.5);
        }
        .success-release-row {
            background-color: rgba(209, 231, 221, 0.3);
        }
        .success-release-row:hover {
            background-color: rgba(209, 231, 221, 0.5);
        }
        .confirmed-payment-row {
            background-color: rgba(207, 226, 255, 0.3);
        }
        .confirmed-payment-row:hover {
            background-color: rgba(207, 226, 255, 0.5);
        }
        .wrong-payment-tag {
            font-size: 0.65rem;
            padding: 1px 5px;
            border-radius: 8px;
            background-color: #dc3545;
            color: white;
            margin-left: 5px;
            vertical-align: middle;
        }
        .expired-tag {
            font-size: 0.65rem;
            padding: 1px 5px;
            border-radius: 8px;
            background-color: #6c757d;
            color: white;
            margin-left: 5px;
            vertical-align: middle;
        }
        .wallet-address {
            font-family: monospace;
            font-size: 0.9rem;
        }
        .balance-info {
            width: 100px;
            display: inline-block;
        }
        .unverified-row {
            background-color: rgba(234, 179, 8, 0.05);
        }
        .wrong-payment-row {
            background-color: rgba(220, 38, 38, 0.15) !important;
            border-left: 4px solid #dc2626 !important;
        }
        .wrong-payment-details {
            background-color: rgba(220, 38, 38, 0.05);
            border-left: 4px solid #dc2626;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
        }
        .action-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .action-button-primary {
            background: var(--primary-color);
            color: white;
            border: none;
        }
        .action-button-primary:hover {
            background: var(--secondary-color);
        }
        .action-button-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        .action-button-outline:hover {
            background: var(--primary-color);
            color: white;
        }
        .address-card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }
        .address-card .address {
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }
        .copy-button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            background: var(--background-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
        }
        .copy-button:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            background: var(--card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        .toast.success {
            border-left: 4px solid var(--success-color);
        }
        .toast.error {
            border-left: 4px solid var(--danger-color);
        }
        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            .stats-card {
                margin-bottom: 1rem;
            }
            .transaction-table {
                font-size: 0.9rem;
            }
        }
        .action-button-danger {
            background: var(--danger-color);
            color: white;
            border: none;
        }
        .action-button-danger:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="mb-4">Admin Dashboard</h1>
                <p class="lead">Monitor all user and merchant activities, transactions, and payment addresses. <strong>No sensitive data is ever shown.</strong></p>
            </div>
        </div>
        <!-- Summary cards, tables, and advanced features will be added here. -->
        <div id="admin-dashboard-content"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
    // --- Admin Dashboard Master Control JS ---
    // Utility: Fetch JSON file (local or server)
    async function fetchJSON(path) {
        try {
            const res = await fetch(path);
            if (!res.ok) throw new Error(`Failed to fetch ${path}: ${res.status}`);
            return await res.json();
        } catch (err) {
            showToast(`Error loading ${path}: ${err.message}`, 'danger');
            return null;
        }
    }

    // Utility: Show toast
    function showToast(msg, type = 'info') {
        let toast = document.getElementById('admin-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'admin-toast';
            toast.className = 'toast position-fixed bottom-0 end-0 m-4';
            toast.style.zIndex = 9999;
            document.body.appendChild(toast);
        }
        toast.innerHTML = `<div class='alert alert-${type} mb-0'>${msg}</div>`;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3500);
    }

    // Utility: Format date
    function fmtDate(dt) {
        if (!dt) return '-';
        const d = new Date(dt);
        return d.toLocaleString();
    }

    // Utility: Status badge
    function statusBadge(status) {
        const map = {
            confirmed: 'success',
            pending: 'warning',
            wrong: 'danger',
            expired: 'secondary',
            failed: 'danger',
            success: 'success',
            payment: 'info',
            release: 'success',
        };
        const color = map[status] || 'secondary';
        return `<span class="badge bg-${color} text-uppercase">${status}</span>`;
    }

    // Utility: Escape HTML
    function esc(str) {
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }

    // Main: Load and render dashboard
    async function loadAdminDashboard() {
        // Robust fetch: try both files, show warnings if missing, but always render dashboard
        const keys = await fetchJSON('Json/keys.json');
        const merchantTxs = await fetchJSON('merchant_transactions.json');

        if (!keys && !merchantTxs) {
            document.getElementById('admin-dashboard-content').innerHTML = 
                '<div class="alert alert-danger">No activity data found. Please ensure <code>Json/keys.json</code> and <code>merchant_transactions.json</code> are present and accessible by your server.</div>';
            return;
        }

        // --- 1. Parse all activities ---
        let activities = [];
        // a) From keys.json activeAddresses
        if (keys && keys.activeAddresses) {
            for (const [address, data] of Object.entries(keys.activeAddresses)) {
                activities.push({
                    type: 'address',
                    address,
                    status: data.status || 'pending',
                    cryptoType: data.cryptoType || '-',
                    amount: data.ethAmount || data.amount || '-',
                    expectedAmount: data.expectedAmount || '-',
                    fiatAmount: data.fiatAmount || '-',
                    fiatCurrency: data.fiatCurrency || '-',
                    createdAt: data.createdAt,
                    expiresAt: data.expiresAt,
                    isWrongPayment: !!data.isWrongPayment,
                    isExpired: !!data.isExpired,
                    wrongReason: data.wrongReason || '',
                    source: 'keys.json',
                    raw: data
                });
            }
        }
        // b) From merchant_transactions.json (if any)
        if (merchantTxs && Array.isArray(merchantTxs)) {
            for (const tx of merchantTxs) {
                activities.push({
                    type: 'transaction',
                    address: tx.address || '-',
                    status: tx.status || '-',
                    cryptoType: tx.cryptoType || '-',
                    amount: tx.amount || '-',
                    expectedAmount: tx.expectedAmount || '-',
                    fiatAmount: tx.fiatAmount || '-',
                    fiatCurrency: tx.fiatCurrency || '-',
                    createdAt: tx.createdAt,
                    expiresAt: tx.expiresAt,
                    isWrongPayment: !!tx.isWrongPayment,
                    isExpired: !!tx.isExpired,
                    wrongReason: tx.wrongReason || '',
                    source: 'merchant_transactions.json',
                    raw: tx
                });
            }
        }

        // --- 2. Summary stats ---
        const total = activities.length;
        const pending = activities.filter(a => a.status === 'pending').length;
        const confirmed = activities.filter(a => a.status === 'confirmed').length;
        const wrong = activities.filter(a => a.status === 'wrong').length;
        const expired = activities.filter(a => a.status === 'expired').length;

        // --- 3. Render summary cards ---
        let summaryHTML = `
        <div class="row mb-4">
            <div class="col-md-3 mb-2">
                <div class="stats-card text-center">
                    <div class="stats-value">${total}</div>
                    <div class="stats-label">Total Activities</div>
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <div class="stats-card text-center">
                    <div class="stats-value">${pending}</div>
                    <div class="stats-label">Pending</div>
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <div class="stats-card text-center">
                    <div class="stats-value">${confirmed}</div>
                    <div class="stats-label">Confirmed</div>
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <div class="stats-card text-center">
                    <div class="stats-value">${wrong}</div>
                    <div class="stats-label">Wrong Payment</div>
                </div>
            </div>
        </div>
        `;

        // --- 4. Render master table ---
        let tableHTML = `
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">All Activities (User & Merchant)</h5>
                <div class="mb-2">
                    <input type="text" class="form-control" id="admin-search" placeholder="Search by address, status, type...">
                </div>
                <div class="table-responsive transaction-table">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Address</th>
                                <th>Status</th>
                                <th>Crypto</th>
                                <th>Amount</th>
                                <th>Fiat</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="admin-activity-table">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        `;

        document.getElementById('admin-dashboard-content').innerHTML = summaryHTML + tableHTML;

        // --- 5. Render table rows ---
        function renderTableRows(filter = '') {
            let rows = '';
            const f = filter.trim().toLowerCase();
            activities.forEach((a, i) => {
                if (f && !(
                    (a.address && a.address.toLowerCase().includes(f)) ||
                    (a.status && a.status.toLowerCase().includes(f)) ||
                    (a.type && a.type.toLowerCase().includes(f))
                )) return;
                rows += `<tr class="${a.isWrongPayment ? 'wrong-payment-row' : a.isExpired ? 'expired-address-row' : ''}">
                    <td>${esc(a.type)}</td>
                    <td><span class="wallet-address">${esc(a.address)}</span></td>
                    <td>${statusBadge(a.status)}</td>
                    <td>${esc(a.cryptoType)}</td>
                    <td>${esc(a.amount)}</td>
                    <td>${esc(a.fiatAmount)} ${esc(a.fiatCurrency)}</td>
                    <td>${fmtDate(a.createdAt)}</td>
                    <td>${fmtDate(a.expiresAt)}</td>
                    <td><button class="btn btn-sm btn-outline-primary" data-idx="${i}" onclick="showAdminDetails(${i})">View</button></td>
                </tr>`;
            });
            document.getElementById('admin-activity-table').innerHTML = rows || '<tr><td colspan="9" class="text-center">No activities found.</td></tr>';
        }
        renderTableRows();
        document.getElementById('admin-search').addEventListener('input', e => renderTableRows(e.target.value));

        // --- 6. Details modal ---
        window.showAdminDetails = function(idx) {
            const a = activities[idx];
            let modal = document.getElementById('admin-details-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'admin-details-modal';
                modal.className = 'modal fade';
                modal.tabIndex = -1;
                modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Activity Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="admin-details-body"></div>
                    </div>
                </div>`;
                document.body.appendChild(modal);
            }
            // Render details (no secrets)
            let html = `<table class="table table-bordered">
                <tr><th>Type</th><td>${esc(a.type)}</td></tr>
                <tr><th>Address</th><td>${esc(a.address)}</td></tr>
                <tr><th>Status</th><td>${statusBadge(a.status)}</td></tr>
                <tr><th>Crypto</th><td>${esc(a.cryptoType)}</td></tr>
                <tr><th>Amount</th><td>${esc(a.amount)}</td></tr>
                <tr><th>Expected Amount</th><td>${esc(a.expectedAmount)}</td></tr>
                <tr><th>Fiat</th><td>${esc(a.fiatAmount)} ${esc(a.fiatCurrency)}</td></tr>
                <tr><th>Created</th><td>${fmtDate(a.createdAt)}</td></tr>
                <tr><th>Expires</th><td>${fmtDate(a.expiresAt)}</td></tr>
                <tr><th>Source</th><td>${esc(a.source)}</td></tr>
                ${a.isWrongPayment ? `<tr><th>Wrong Payment Reason</th><td class='text-danger'>${esc(a.wrongReason)}</td></tr>` : ''}
                ${a.isExpired ? `<tr><th>Expired</th><td class='text-secondary'>Yes</td></tr>` : ''}
            </table>`;
            document.getElementById('admin-details-body').innerHTML = html;
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        };
    }

    // --- On page load ---
    document.addEventListener('DOMContentLoaded', loadAdminDashboard);
    </script>
</body>
</html> 