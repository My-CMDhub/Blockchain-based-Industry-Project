<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrong Payment Test Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8fafc;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: none;
        }
        .copy-btn {
            cursor: pointer;
        }
        pre {
            background-color: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        .qr-container {
            text-align: center;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Wrong Payment Test Tool</h3>
            </div>
            <div class="card-body">
                <p class="mb-4">This tool helps you test wrong payment detection. It generates a payment address with an expected amount, and you can send a different amount to trigger the wrong payment detection.</p>
                
                <div class="alert alert-info">
                    <i class="bx bx-info-circle me-2"></i>
                    <span>This is a testing tool. It generates real HD wallet addresses that expect specific payment amounts.</span>
                </div>
                
                <div class="mb-3">
                    <label for="expectedAmount" class="form-label">Expected Amount (ETH):</label>
                    <input type="text" class="form-control" id="expectedAmount" value="0.01">
                </div>
                
                <button class="btn btn-primary mb-4" onclick="generatePayment()">
                    <i class="bx bx-wallet me-2"></i> Generate Payment Address
                </button>
                
                <div id="paymentInfo" style="display: none;">
                    <div class="alert alert-success mb-3">
                        <strong>Payment Address Generated!</strong>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment ID:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="paymentId" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('paymentId')">
                                        <i class="bx bx-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Address:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="address" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('address')">
                                        <i class="bx bx-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expected Amount:</label>
                                <input type="text" class="form-control" id="amount" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Wrong Amount (to test):</label>
                                <input type="text" class="form-control" id="wrongAmount" placeholder="Enter a different amount">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="qr-container">
                                <h5>Scan QR Code</h5>
                                <div id="qrcode"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mb-4">
                        <h5><i class="bx bx-bulb me-2"></i>Testing Instructions:</h5>
                        <ol>
                            <li>Send a different amount (not the expected amount) to the generated address</li>
                            <li>This should trigger the wrong payment detection mechanism</li>
                            <li>Check the merchant dashboard to see the wrong payment record</li>
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-primary me-2" onclick="openPaymentStatus()">
                            <i class="bx bx-check-circle me-2"></i> Check Payment Status
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goToMerchantDashboard()">
                            <i class="bx bx-dashboard me-2"></i> View Merchant Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="responseContainer" style="display: none;">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Response Data</h5>
                </div>
                <div class="card-body">
                    <pre id="responseData"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script>
        let currentPaymentData = null;
        
        async function generatePayment() {
            try {
                const expectedAmount = document.getElementById('expectedAmount').value.trim();
                
                // Validate amount
                if (!expectedAmount || isNaN(parseFloat(expectedAmount)) || parseFloat(expectedAmount) <= 0) {
                    alert('Please enter a valid amount greater than 0');
                    return;
                }
                
                // Call the API to generate a payment address
                const response = await fetch(`/api/generate-test-payment?amount=${expectedAmount}`);
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                currentPaymentData = data;
                
                // Display the response
                document.getElementById('responseData').textContent = JSON.stringify(data, null, 2);
                document.getElementById('responseContainer').style.display = 'block';
                
                // Fill in the payment info
                document.getElementById('paymentId').value = data.id;
                document.getElementById('address').value = data.address;
                document.getElementById('amount').value = data.expectedAmount;
                
                // Calculate a wrong amount (110% of expected amount)
                const suggestedWrongAmount = parseFloat(data.expectedAmount) * 1.1;
                document.getElementById('wrongAmount').value = suggestedWrongAmount.toFixed(8);
                
                // Generate QR code for the address
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = ''; // Clear previous QR code
                
                QRCode.toCanvas(qrContainer, `ethereum:${data.address}`, {
                    width: 200,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                }, function (error) {
                    if (error) console.error('Error generating QR code:', error);
                });
                
                // Show the payment info
                document.getElementById('paymentInfo').style.display = 'block';
                
                // Scroll to payment info
                document.getElementById('paymentInfo').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error generating payment:', error);
                alert(`Error generating payment: ${error.message}`);
            }
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');
            
            // Show a toast or notification
            alert(`Copied to clipboard: ${element.value}`);
        }
        
        function openPaymentStatus() {
            if (!currentPaymentData || !currentPaymentData.id) {
                alert('No payment data available');
                return;
            }
            
            window.open(`/payment-status.html?id=${currentPaymentData.id}`, '_blank');
        }
        
        function goToMerchantDashboard() {
            window.open('/merchant', '_blank');
        }
    </script>
</body>
</html> 